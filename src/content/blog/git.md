---
title: "Git"
topics: ["notes"]
duration: "1min"
pubDate: "October 05 2023"
lang: "en-us"
draft: true
---

```sh
git commit --amend

git commit --amend -m "an updated commit message"
```

> https://www.atlassian.com/zh/git/tutorials/rewriting-history


## 管理建议

>   根据当下团队实际情况进行适配，后续需要持续优化成标准化流程

### 任务卡/分支管理

#### 创建任务卡

##### 命名

 **提交类型** + **任务 ID ** + **简要描述** （任务卡和分支名同步）

例如：**feat-26373-活动管理**

##### 任务描述

**产品文档**： 直接复制当前任务卡所含的文字内容。最好含有**预期结果**

**原型图**：直接复制当前页面原型图，如果只包含当前页面的部分功能则进行框选备注

**需求变更**： 有产品文档变更，可直接复制修改内容并关联原开发任务卡号；

如果无文档支持，则复制聊天记录截图确认需求

**需求变更**：有测试产出的需求问题，可通过测试用例进行描述，或者复制聊天记录截图确认需求

【可选】如果可以，请附加 **测试用例**文件。

##### 工时

需求任务卡工期最好控制在 **3天** 以内，同一个任务连续多周开发，请合理进行拆分任务。

#### 编辑任务卡

工时跟踪（略）

#### 完成/关闭任务卡

**是否完成任务卡**：以提交 MR **是否合并** 开发分支为标准

PS: 工时在原有基础上增加 0.5，防止避免禅道自动完成

**暂时不允许自己关闭任务卡！**

**暂时不允许自己关闭任务卡！**

**暂时不允许自己关闭任务卡！**

#### 可能存在的问题

-   因合作存在的 delay/block 问题，保证代码准确性的情况下先进行 MR 合并
-   因不可抗拒因素导致的 block 问题，请移交其他同事进行同分支的后续开发，或者保证代码准确性的情况下先进行 MR 合并。

#### Release Notes

暂时人为统计处理，处理办法如下：

-   通过禅道进行筛选条件获取结果
    -   任务状态 = 已完成
    -   任务类型 = 前端开发
-   全选搜索结果并导出下载 csv
-   csv 数据转换为 Release Note - markdown ( 工具化 )
-   发版成功后将搜索结果统一改为已结束

模板例子

```markdown
Release Notes - Version 1.0.0
Date: 2023-01-01

Features
 - 123-新增活动规则表单
 - 124-新增活动规则类型
 - 125-增加转盘主题
 
Bugs
 - 144-修复标签页跳转数据丢失@author
 - 145-修复表格样式错位@author
 
Refactors
 - 150-优化活动规则类型定义@author
 - 151-删除无用的公共组件@author

```

### 工作流程管理

建议新增 **API 评审**

该流程和 **测试用例评审** 同步进行

根据原型图/UI 图，进行前端所有需要的接口文档设计

该流程避免以下问题：

-   接口返回值无固定实体/复用冗余实体/类型不同返回不同的实体
-   无法创建通用 TS 类型对象且易混淆
-   避免频繁的沟通成本


#### 关闭文件大小写忽略规则
```sh
git config core.ignorecase false
```

#### 合并策略调整为Rebase
```sh
git config --global pull.rebase true
```

#### 删减过期远程分支
```sh
git remote prune origin
```

#### 分支强制推送（仅限本地开发分支）
```sh
git push --force-with-lease
```

#### 本地开发分支压缩
```sh
// hash 为分支切出点
git rebase -i [hash]
// 除首次提交都调整为squash（压缩）模式
s [hash]
// 保存执行操作
:wq
// 按标准修改整合commit名称
commit	xxx
//  保存执行commit
:wq
```

## 分支相关
- marketing-campaign-web：营销活动
	**dev** 切出 开发分支。
	MR 合并至 **dev** 分支，进行代码审核
	
- platform-marketing-web：灵明通平台
	**master** 切出 开发分支。
	MR 合并至 **test** 分支，进行代码审核。










## Git 流程规范文档

>   开发分支工作流

### 安装Git （略）

### 配置 Git 用户信息

#### 基本信息配置

```shell
git config --global user.name "Your Name"
git config --global user.email "youremail@example.com"
```

#### 合并策略配置

在多人协作中，通常推荐使用 "rebase" 合并策略以保持干净的提交历史。您可以配置 Git 在 `pull` 操作中使用 `rebase`，而不是默认的 `merge`。

```shell
git config --global pull.rebase true
```

### Git 存储库

#### 创建新的 Git 存储库（简略）

```shell
git init
```

##### 配置 `.gitignore` 文件

```bash
# 排除临时文件
*.log
# 排除依赖目录
node_modules/
# 排除打包文件
dist/
# 排除本地用户文件,如 IDE 配置文件
.vscode/
```

#### 克隆现有 Git 存储库

```shell
git clone http://gitw.wktop.cn:32012/platform-name/project-name.git
// or
git clone ssh://git@gitw.wktop.cn:32012/platform-name/project-name.git
```

### 创建分支

#### 创建主分支

**该分支必须要有主分支（master）切出**。

```shell
git checkout -b new-branch-name
```

##### 开发分支命名规范

1.  开发分支：生产发版后的定版分支。以下二选一
    1.  使用 "release" 前缀 + 版本号
    2.  使用 "dev" 前缀 + 版本号
2.  热修复分支：用于紧急修复现有版本中的问题。使用 "hotfix" 前缀 + 任务ID(可选) + 修复问题
3.  版本号规范：项目版本号采用`主要.次要.修订`（Major.Minor.Patch）的形式
    1.  **主要版本号**：当进行不兼容的 API 更改或重大的功能修改时 - refactoring
    2.  **次要版本号**：当添加新功能或进行向后兼容的功能修改 - feature
    3.  **修订版本号**：当进行向后兼容的 bug 修复或小的改进 - hotfix
    4.  项目制的版本号：使用需求编码+版本号

**例如： release-1.1.1** 

#### 创建子分支

**该分支必须要有未封版开发分支（dev）切出**。

>    该分支命名主要用于 `dev` 的合并提交后的 `Squash commit` 。

##### 子分支命名规范

**提交类型** + **任务 ID ** + **简要描述**

**提交类型**：

1.  项目初始化：`init ` 
2.  添加新特性：`feat` 
3.  修复bug：`fix` 
4.  优化相关，如提升性能、体验：`perf` 
5.  代码回滚：`revert` 
6.  仅修改缩进，空格等，不影响代码逻辑：`style`
7.  仅修改文档，如readme：`docs` 

**任务 ID**：关联**禅道**管理工具，便于跟踪该分支工作进度和工时，用于统计管理

>   可升级为 集成 Github Webhooks机制，以便自动跟踪问题与分支、提交和拉取请求之间的关联。
>
>   同类产品 Jira的配置文档：https://developer.atlassian.com/server/jira/platform/webhooks/

**例如： feat-123-新增活动规则表单**

### 切换分支

使用 `git checkout` 命令来切换到不同的分支。

使用 `git branch` 命令查看本地仓库分支，使用 `git branch -a` 命令查看仓库所有分支。

```shell
git branch -a
git checkout branch-name
```

### 更新分支

#### 添加和提交更改：

```shell
git add .  # 添加所有更改到暂存区
git commit -m "Your commit message"  # 提交更改并附带提交消息
```

-   **仔细选择要提交的更改**
    -   使用 `git status` 命令来查看尚未暂存的更改
    -   使用 `git diff` 命令来查看更改的具体内容
-   **分阶段提交**：多个文件进行了更改时，使用 `git add` 命令来逐个文件或部分文件添加到暂存区
-   **定期提交**：以确保工作得到保存并具有版本历史
-   **验证更改的正确性**：运行适当的测试以捕获潜在的错误

需要注意：

-   子分支 `commit` 最终会合并到 MR Title
-   主分支需进行分支保护

#### 同步远程仓库：

```shell
git push origin branch-name 
```

>   避免适用 `--force` 进行提交

### 合并分支

-   **确保基础分支（目标分支）是最新的**：在合并分支之前，确保您的基础分支（通常是主分支，如`main`或`master`）是最新的。可以使用 `git pull`命令更新。
-   **执行合并操作**：创建 `merge request` 请求来完成此操作。
-   **测试合并后的代码**：在合并后，测试以确保代码在合并后仍然正常工作。
-   **删除不再需要的分支**：一旦分支成功合并，通常建议删除不再需要的分支以保持代码库的整洁。可在 MR 设置勾选 `Delete source branch when merge request is accepted` 选项。也可以手动执行一下命令：
    -   删除本地分支：`git branch -d branch-name`
    -   删除远程分支：`git push origin --delete branch-name

#### 合并子分支

-   提交 `merge request` ：feature -> dev
-   勾选 `Squash commits when merge request is accepted`
-   Title 符合**命名规范** ：默认为 合并后的 `commit` 信息
-   需要 1-2 个 `Reviewer`

#### 合并主分支

-   提交 `merge request` : dev -> master
-   **不勾选** `Squash commits when merge request is accepted`
-   Title 为 开发分支名称： release/dev + 版本号
-   需要 1-2 个 `Reviewer`

### 解决冲突

#### 避免冲突的发生

-   **开发独立的功能或模块**：尽量避免多人同时修改同一文件或同一行代码。将工作划分成独立的功能或模块，以减少冲突的可能性
-   **保持与远程分支同步**：定期使用 `git pull` 更新您的本地分支
-   **保持与主分支同步**：适用 `git rebase `同步您的本地分支与主分支的代码
-   **代码审查**：通过 MR 的代码比对进行自查和他查
-   **统一规范编程风格**：主要体现在**代码格式化**，通过配置文件来强制编码规范
-   **加强团队沟通**：如果多人需要修改同一部分代码，可以先协商和计划
-   **使用 Git 钩子**：自动触发代码审查脚本的机制。例如: git hooks + husky + lint-staged

#### 解决冲突的方法

-   **基于开发分支进行Rebase**：使用 `git rebase` 来重新应用您的本地更改。这可以减少冲突的机会。
-   VS code - **merge tool**：这些工具通常允许您可视化地比较和合并冲突，然后选择要保留的更改。

### 封板发布

#### 版本号更新

一般情况在开发分支开始时，更新版本号。如果未及时更新应该可在开发分支合并主分支时，进行版本号修改

#### 封板打标签

使用 `git tag` 命令进行标记 **发布版本** 的稳定点的引用。也可以在 release 页面进行同步创建

#### 生成发布说明

用于向用户、团队和其他相关方提供有关软件版本的信息。包括了新功能、改进、修复的问题以及其他与版本相关的详细信息

**任务ID** + **简要描述**

```markdown
Release Notes - Version 1.0.0
Date: 2023-01-01

Features
 - 123-新增活动规则表单
 - 124-新增活动规则类型
 - 125-增加转盘主题
 
Bugs
 - 144-修复标签页跳转数据丢失
 - 145-修复表格样式错位
 
Refactors
 - 150-优化活动规则类型定义
 - 151-删除无用的公共组件

```



### 本地分支清理

#### 更新远程分支信息

在执行删除操作之前，首先确保您的本地分支列表是最新的。运行以下命令以获取远程分支信息： 

```shell
git fetch -p
```

`-p` 或 `--prune` 选项会删除本地不存在的远程分支引用。

也可以使用以下命令**清理远程分支引用的过期数据**

```shell
git remote prune
```

#### 列出本地分支并删除不存在的分支

 您可以使用以下命令列出本地分支，并删除那些在远程存储库中不存在的分支：

```shell
git branch | grep -v "\* " | xargs git branch -d
```

这个命令首先列出所有本地分支（不包括当前分支），然后使用 `xargs` 命令将它们传递给 `git branch -d` 命令，该命令尝试删除每个分支。

请注意，`git branch -d` 尝试删除分支，但如果分支包含未合并的更改，它将无法删除。如果您希删除未合并的分支，可以使用 `-D` 选项代替 `-d`，即 `git branch -D branch-name`。

>   注意：以上操作对本地仓库是不可逆的！如果存在未合并的更改请谨慎操作。
>
>   远程可 执行 `restore`

#### 未推送的分支

查看本地分支相对于远程分支的差异，以查找未推送的更改。

```shell
git cherry -v
```





### 关于 Hotfix 分支处理办法

Hotfix 分支是一种用于处理紧急修复的 Git 分支。通常情况下，Hotfix 分支用于修复**生产环境**中的紧急错误或问题，而不会等待下一个正常的发布周期。

#### 创建 Hotfix 分支

从生产环境分支（ `master` 分支）创建一个新的 Hotfix 分支。

这个分支**命名规范**： "hotfix" 前缀 + 任务ID(可选) + 描述性的名称。例如 "hotfix-123-修复表单样式错位"

#### 进行紧急修复

在 Hotfix 分支上进行必要的代码修复，并**修改版本号**

#### 提交修复

提交您的修复并将更改推送到远程 Hotfix 分支

#### 进行测试

在 Hotfix 分支上进行测试，以确保修复有效，并且不引入新问题。测试通常包括单元测试、集成测试和功能测试

#### 合并 Hotfix 分支 & 删除 Hotfix 分支

将 Hotfix 分支提交 Merge Request 合并回主分支(`master` 分支)，以应用修复到生产环境。

#### 发布修复

对主分支进行 tag ，将对应 tag 打包部署到生产环境

#### 同步到开发分支

将开发分支重播主分支

```shell
git checkout master #切换master 主分支
git pull #master 更新主分支
git checkout dev #切换 dev 开发分支
git rebase master #同步 hotfix 代码
git push #更新 dev 开发分支
```

#### 编写事故报告

有助于团队了解问题的性质、原因和修复方法，以及采取措施防止类似的问题再次发生。

事故报告以便团队和利益相关方了解问题的全貌和处理过程。此外，事故报告还应该作为团队的学习工具，以帮助改进流程、减少类似问题的发生。

事故报告应包含的关键信息：

##### 事故描述

详细描述问题、事故或紧急情况。包括问题的性质、严重性级别和对系统或服务的影响

##### 事发时间

记录事故发生的确切日期和时间。这有助于确定何时事故首次发生以及持续了多长时间

##### 事故发现方式

说明问题是如何被发现的，是通过监控、用户报告、测试等方式

##### 受影响的系统或组件

列出受事故影响的系统、模块或组件。这有助于确定问题的范围

##### 事故原因分析

提供问题发生的根本原因分析。这可能包括技术原因、人为原因、过程问题等。使用根本原因分析工具，如5 Whys，来深入了解问题

##### 应急措施

描述在问题发现后采取的紧急措施。这可以包括暂停服务、回滚版本等

##### 修复过程

说明问题的修复过程，包括 Hotfix 分支的创建、代码更改、测试、合并到主分支和部署等步骤，责任到人

##### 修复效果

记录问题修复后的效果，包括问题是否已解决、修复是否引入了新问题以及生产环境是否已经稳定

##### 事后措施

说明为防止类似问题再次发生而采取的措施。这可能包括改进开发流程、加强测试、增加监控等

##### 团队反馈

进行事故总结会。收集团队成员的反馈和意见，以便了解问题的处理方式是否得当以及如何改进

##### 未来工作

记录需要进一步进行的工作，例如长期解决方案或系统改进

##### 领导层汇报通知

通知管理层或利益相关方问题的发生和处理方式



## 开发分支工作流

基于开发分支的工作流是一种常见的 Git 工作流程，用于多人协作开发项目。它有助于保持主分支（通常是`main`或`master`）的稳定性，同时允许开发者在独立的分支上进行工作。以下是基于开发分支的工作流的基本概念：

1. **主分支**：主分支是代码库的主要分支，包含稳定的、已测试的代码。这通常是用于生产部署的分支。

2. **开发分支**：在基于开发分支的工作流中，开发者不直接在主分支上工作。相反，他们在一个专门的开发分支上进行工作，通常称为`develop`或`dev`分支。这是一个集成开发工作的分支。

3. **特性分支**：每当开发者开始一个新的功能或修复一个问题时，他们会从开发分支派生一个特性分支。这些分支通常按功能或任务卡编号进行命名，例如`feature/new-feature`或`bugfix/issue-123`。

4. **独立工作**：每个开发者在独立的特性分支上工作，修改和测试功能或修复。这允许开发者在不干扰主分支或其他开发者的情况下进行工作。

5. **提交和推送**：开发者在特性分支上进行工作，定期提交更改。这有助于跟踪工作的进展并创建有意义的提交历史。他们还可以将特性分支推送到远程存储库，以与其他开发者分享他们的工作。

6. **代码审查**：在完成特性或修复之后，开发者通常会请求代码审查，以确保质量和一致性。审查人员检查代码并提供反馈。

7. **合并到开发分支**：一旦特性分支上的工作被批准，它们会合并到开发分支。这可以使用合并或重播（rebase）操作来完成。

8. **集成测试**：在开发分支上进行的更改可能需要进行集成测试，以确保它们与其他特性和开发工作正常协作。

9. **发布准备**：当开发分支上的功能已经达到发布的标准，团队可以准备将其合并到主分支，进行生产部署。

10. **发布主分支**：一旦在开发分支上的工作经过充分测试并得到批准，它们会合并到主分支，然后进行生产部署。

这种基于开发分支的工作流有助于隔离和管理不同的特性和修复，并降低主分支上出现问题的风险。它还鼓励团队合作，采用团队约定，以确保代码质量和一致性。这种工作流程适用于中等到大型项目，其中有多个开发者需要协同工作。



## Git Hooks

可以在 Git 特定事件发生时自动触发的脚本。这些事件包括提交、合并、推送等。您可以使用 Git 钩子来执行自定义操作，例如运行测试、部署代码或执行其他自动化任务。Git 钩子是存储在`.git/hooks`目录中的可执行脚本文件。

#### 常用的钩子

-   **pre-commit** : 执行提交之前触发,可以使用它来运行代码风格检查、静态分析或测试。如果钩子脚本返回非零退出状态，提交将被阻止
-    **prepare-commit-msg**：在提交消息编辑器启动之前触发，可以用于自动化提交消息的生成
-   **post-commit**：提交操作完成后触发。您可以在此处执行一些后续操作，如通知或日志记录。

#### Husky

管理 Git 钩子（Git Hooks）的工具，它可以帮助开发者在 Git 特定事件发生时自动触发脚本。

1.  **易于配置**：Husky 的配置相对简单，可以通过在项目的 `package.json` 文件中定义钩子脚本，也可以在单独的配置文件中进行定义。
2.  **自动触发**：Husky 确保在特定 Git 事件发生时自动触发脚本，无需手动运行。
3.  **可扩展性**：Husky 可与其他工具和插件一起使用，以满足特定项目需求，例如 lint-staged、linters、测试框架等。
4.  **平台独立**：Husky 可以在不同的操作系统上运行，包括 macOS、Linux 和 Windows。

#### Lint-staged 

一个用于在提交前对暂存的文件运行 linters 和代码格式检查工具的工具。它通常与 Husky 或其他 Git 钩子一起使用，以确保只有经过检查的代码才能提交到版本控制系统中。

1.  **基于 Git 暂存区的文件**：lint-staged 会检查仅在 Git 暂存区中的文件，这确保了只有准备提交的更改受到检查，而不是整个代码库。
2.  **集成多种工具**：lint-staged 可以集成各种代码规范工具和 linters，例如 ESLint、Prettier、TSLint、stylelint、JSHint 等。
3.  **定制检查规则**：您可以在 lint-staged 配置中指定要运行的检查规则和工具，以满足项目的特定需求。
4.  **并行执行**：lint-staged 可以并行运行多个检查工具，提高了效率。
5.  **自定义错误处理**：您可以自定义如何处理检查失败的情况，例如阻止提交、生成报告或其他自定义操作。

#### 使用例子

```json
// package.json
{
  "scripts": {
    "lint-staged": "lint-staged"
  },
  "lint-staged": {
    "*.{js,ts,vue}": "eslint --cache", // 只需要检查您对代码进行了更改的文件，而不需要检查整个项目。提效
    // "*.{js,ts,vue}": ["eslint --fix", "prettier --write"], // 尝试自动修复可修复的规则并自动格式化它们
    "*.**": "prettier --ignore-unknown"
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  }
}
```




